---
name: Branch Protection Reminder

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: true

permissions:
  contents: read

jobs:
  check-branch-protection:
    runs-on: ubuntu-latest
    name: Verify Branch Protection

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if branch protection is enabled
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîç Checking branch protection status..."

          # Try to get branch protection info
          REPO="${{ github.repository }}"
          if gh api repos/$REPO/branches/main/protection \
              > /dev/null 2>&1; then
            echo "‚úÖ Branch protection is enabled for main branch"

            # Display current protection settings
            echo ""
            echo "Current protection settings:"
            gh api repos/$REPO/branches/main/protection | jq '{
              require_pull_request_reviews: .required_pull_request_reviews,
              enforce_admins: .enforce_admins.enabled,
              allow_force_pushes: .allow_force_pushes.enabled,
              allow_deletions: .allow_deletions.enabled
            }'
          else
            echo "‚ö†Ô∏è  WARNING: Branch protection is NOT enabled!"
            echo ""
            echo "To protect your main branch:"
            echo "1. Run: ./.github/setup-branch-protection.sh"
            echo "2. Or follow manual setup in BRANCH_PROTECTION.md"
            echo "3. Or visit:"
            echo "   https://github.com/$REPO/settings/branches"
            echo ""
            echo "This prevents:"
            echo "  - Force pushes to main"
            echo "  - Accidental deletion of main"
            echo "  - Direct commits without review"
            exit 1
          fi

      - name: Verify force push protection
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîí Verifying force push protection..."

          REPO="${{ github.repository }}"
          FORCE_PUSH=$(gh api repos/$REPO/branches/main/protection \
            | jq -r '.allow_force_pushes.enabled')

          if [ "$FORCE_PUSH" = "true" ]; then
            echo "‚ö†Ô∏è  WARNING: Force pushes are ALLOWED!"
            echo "This should be disabled for security."
            exit 1
          else
            echo "‚úÖ Force pushes are disabled (secure)"
          fi

      - name: Verify deletion protection
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üóëÔ∏è  Verifying deletion protection..."

          REPO="${{ github.repository }}"
          ALLOW_DELETIONS=$(gh api repos/$REPO/branches/main/protection \
            | jq -r '.allow_deletions.enabled')

          if [ "$ALLOW_DELETIONS" = "true" ]; then
            echo "‚ö†Ô∏è  WARNING: Branch deletion is ALLOWED!"
            echo "This should be disabled for security."
            exit 1
          else
            echo "‚úÖ Branch deletion is disabled (secure)"
          fi

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "========================================="
          echo "‚úÖ All branch protection checks passed!"
          echo "========================================="
          echo ""
          echo "Your main branch is properly protected:"
          echo "  ‚úì Force pushes: DISABLED"
          echo "  ‚úì Deletions: DISABLED"
          echo "  ‚úì Pull request reviews: REQUIRED"
